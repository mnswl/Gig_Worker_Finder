"use strict";(self.webpackChunkfrontend=self.webpackChunkfrontend||[]).push([[125],{3125:(e,t,s)=>{s.r(t),s.d(t,{default:()=>l});var n=s(5043),a=s(4117),i=s(3216),r=s(2115),c=s(1562),d=s(9442),o=s(579);const l=function(){const e=(0,i.Zp)(),{t:t}=(0,a.Bd)(),s=(0,i.zy)(),l=new URLSearchParams(s.search),u=l.get("user"),m=l.get("job"),[f,h]=(0,n.useState)([]),[g,p]=(0,n.useState)(null),[x,b]=(0,n.useState)([]),[j,v]=(0,n.useState)(""),[N,w]=(0,n.useState)(!1),y=(0,n.useRef)(null),[_,A]=(0,n.useState)(""),[k,C]=(0,n.useState)(null),S=(0,n.useRef)(null),M=(0,n.useMemo)(()=>{const e=[...f];return e.sort((e,t)=>{if(e.unread&&!t.unread)return-1;if(!e.unread&&t.unread)return 1;const s=new Date(e.updatedAt||e.lastMessageAt||0);return new Date(t.updatedAt||t.lastMessageAt||0)-s}),e},[f]);(0,n.useEffect)(()=>{"Notification"in window&&"default"===Notification.permission&&Notification.requestPermission()},[]),(0,n.useEffect)(()=>{S.current&&(S.current.scrollTop=S.current.scrollHeight)},[x,g]),(0,n.useEffect)(()=>{(async()=>{try{const e=await d.A.get("/auth/me");A(e.data.id)}catch(e){}})()},[]),(0,n.useEffect)(()=>{c.s.connected&&_&&c.s.emit("join",_)},[_]),(0,n.useEffect)(()=>(c.s.on("newMessage",e=>{var t;const s=e.sender._id||e.sender,n=(null===(t=e.receiver)||void 0===t?void 0:t._id)||e.receiver,a=g&&(s===g._id||n===g._id);if(h(t=>{const s=t.findIndex(t=>(t.user._id||t.user)===(e.sender._id||e.sender)),n=!a;let i=[...t];return-1!==s?i[s]={...i[s],lastMessage:e.content,unread:n,updatedAt:e.createdAt}:i.push({user:e.sender,lastMessage:e.content,unread:n,updatedAt:e.createdAt}),i}),a)b(t=>t.some(t=>t._id===e._id)?t:[...t,e]);else{(!document.hasFocus()||!a)&&(r.oR.info(`New message from ${e.sender.name||"Someone"}: ${e.content.slice(0,60)}`),((e,t)=>{if("Notification"in window&&"granted"===Notification.permission)try{console.log("Firing notification",e,t),new Notification(e,{body:t})}catch(s){console.error("Notification error",s)}})(e.sender.name||"New message",e.content))}}),c.s.on("typing",e=>{let{from:t}=e;g&&t===g._id&&(w(!0),y.current&&clearTimeout(y.current),y.current=setTimeout(()=>w(!1),1500))}),()=>{c.s.off("newMessage"),c.s.off("typing")}),[c.s,g]),(0,n.useEffect)(()=>{(async()=>{try{const e=await d.A.get("/chat/conversations");if(h(e.data),u){const t=e.data.find(e=>(e.user._id||e.user)===u);if(t)$(t.user,m);else{const e=await d.A.get(`/users/${u}`);$(e.data,m)}}}catch(e){r.oR.error("Failed to load conversations")}})()},[]);const $=async function(t){let s=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;p(t),h(e=>e.map(e=>(e.user._id||e.user)===t._id?{...e,unread:!1}:e)),C(null),e(`/chat?user=${t._id}${s?`&job=${s}`:""}`);try{if(s)try{const e=await d.A.get(`/jobs/${s}`);C({_id:s,title:e.data.title})}catch(n){}const e=await d.A.get(`/chat/with/${t._id}`);b(e.data)}catch(a){r.oR.error("Failed to load messages")}},E=async()=>{if(j.trim())try{await d.A.post("/chat",{receiverId:g._id,subject:"",content:j.trim(),jobId:k?k._id:null});v("")}catch(e){r.oR.error("Send failed")}};return(0,o.jsxs)("div",{className:"chat-page",children:[(0,o.jsxs)("div",{className:"chat-sidebar",children:[(0,o.jsx)("h5",{className:"p-3 border-bottom",children:"Conversations"}),(0,o.jsx)("ul",{className:"list-group list-group-flush conversation-list",children:M.map(e=>(0,o.jsxs)("li",{className:`list-group-item d-flex align-items-center gap-2 pointer ${g&&(g._id===(e.user._id||e.user)?"active":"")}`,onClick:()=>$(e.user),children:[(0,o.jsx)("div",{className:"avatar-circle bg-primary text-white fw-bold",children:e.user.name?e.user.name.charAt(0).toUpperCase():"?"}),(0,o.jsxs)("div",{className:"flex-grow-1",children:[(0,o.jsx)("div",{className:"fw-semibold",children:e.user.name||"Unknown"}),(0,o.jsx)("small",{className:"text-muted text-truncate d-block",style:{maxWidth:"160px"},children:e.lastMessage})]}),e.unread&&(0,o.jsx)("span",{className:"badge bg-danger ms-auto",children:"\u25cf"})]},e.user._id||e.user))})]}),(0,o.jsx)("div",{className:"chat-main d-flex flex-column",children:g?(0,o.jsxs)(o.Fragment,{children:[(0,o.jsxs)("div",{className:"d-flex justify-content-between align-items-center border-bottom p-3",children:[(0,o.jsxs)("div",{children:[(0,o.jsx)("div",{className:"fw-semibold",children:g.name}),k&&(0,o.jsxs)("small",{className:"text-muted",children:[t("jobLabel"),": ",k.title]})]}),(0,o.jsx)("button",{className:"btn btn-sm btn-outline-secondary",onClick:()=>e("/dashboard"),children:"\xd7"})]}),(0,o.jsxs)("div",{ref:S,className:"flex-grow-1 overflow-auto p-3 messages-container",children:[N&&(0,o.jsxs)("small",{className:"text-muted mb-2",children:[g.name," is typing..."]}),x.map(e=>(0,o.jsx)("div",{className:"d-flex mb-2 "+(e.sender._id===g._id||e.sender===g._id?"align-start":"justify-content-end"),children:(0,o.jsx)("div",{className:"chat-bubble "+(e.sender._id===g._id||e.sender===g._id?"incoming":"outgoing"),children:e.content})},e._id))]}),(0,o.jsxs)("div",{className:"p-3 border-top d-flex gap-2",children:[(0,o.jsx)("input",{className:"form-control",value:j,onChange:e=>{v(e.target.value),g&&c.s.emit("typing",{to:g._id})},placeholder:t("typeMessage"),onKeyDown:e=>{"Enter"!==e.key||e.shiftKey||(e.preventDefault(),E())}}),(0,o.jsx)("button",{className:"btn btn-primary",onClick:E,children:t("send")})]})]}):(0,o.jsxs)("div",{className:"h-100 position-relative",children:[(0,o.jsx)("button",{className:"btn btn-sm btn-outline-secondary position-absolute top-0 end-0 m-3",onClick:()=>e("/dashboard"),children:"\xd7"}),(0,o.jsx)("div",{className:"h-100 d-flex align-items-center justify-content-center",children:(0,o.jsx)("p",{className:"text-muted",children:t("selectConversation")})})]})})]})}}}]);
//# sourceMappingURL=125.0276f590.chunk.js.map